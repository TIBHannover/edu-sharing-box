---
- name: Get the path to the edu-sharing cluster docker volume.
  shell: |
    sg docker -c "docker volume inspect --format '{{ '{{' }}.Mountpoint{{ '}}' }}'  $(sg docker -c "docker volume ls -q |grep '_repository-service-volume-config-cluster'")"
  register: repository_volume_config_cluster
  ignore_errors: true


- name: Let's wait until the alfresco-global.properties is generated by docker container
  become: true
  wait_for:
    path:  '{{repository_volume_config_cluster.stdout}}/alfresco-global.properties'
    state: present
  retries: 10
  delay: 10
  when: (repository_volume_config_cluster.stdout is defined) and (repository_volume_config_cluster.stdout != "")



- include_tasks: remove_alviral_and_mail_from_alfresco_properties.yml
  vars:
      alfresco_global_properties_path: '{{repository_volume_config_cluster.stdout}}'
  when:
    (repository_volume_config_cluster.stdout is defined) and (repository_volume_config_cluster.stdout != "") and
    (install_antivirus is defined ) and ( not install_antivirus)

- include_tasks: add_alviral_to_alfresco_properties.yml
  vars:
      alfresco_global_properties_path: '{{repository_volume_config_cluster.stdout}}'
  when:
    (repository_volume_config_cluster.stdout is defined) and (repository_volume_config_cluster.stdout != "") and
    (install_antivirus is defined ) and ( install_antivirus)

- include_tasks: add_mail_config_to_alfresco_properties.yml
  vars:
      alfresco_global_properties_path: '{{repository_volume_config_cluster.stdout}}'
  when:
    (repository_volume_config_cluster.stdout is defined) and (repository_volume_config_cluster.stdout != "") and
    (install_antivirus is defined ) and ( install_antivirus)

- include_tasks: add_es_update_oersi_to_alfresco_properties.yml
  vars:
      alfresco_global_properties_path: '{{repository_volume_config_cluster.stdout}}'
  when:
    (repository_volume_config_cluster.stdout is defined) and (repository_volume_config_cluster.stdout != "") and
    (activate_es_update_oersi is defined ) and ( activate_es_update_oersi)
